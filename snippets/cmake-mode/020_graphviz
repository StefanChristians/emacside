# -*- mode: snippet -*-
# name: graphviz
# group: module
# --
include_guard(GLOBAL)

# Generate dependency graph

# default location for generated graph
set(CMAKE_GRAPHVIZ_OUTPUT_DIR "output/docs/graph" CACHE STRING "Output directory in build tree for generated dependency graph.")

# default output type
set(CMAKE_GRAPHVIZ_OUTPUT_TYPE "svg" CACHE STRING "Output format for generated dependency graph.")

find_program(GRAPHVIZ_EXECUTABLE dot)
mark_as_advanced(GRAPHVIZ_EXECUTABLE)

if (GRAPHVIZ_EXECUTABLE)
  execute_process(
    COMMAND \$\{GRAPHVIZ_EXECUTABLE\} -V
    ERROR_VARIABLE GRAPHVIZ_VERSION
  )
  string(REGEX REPLACE "^.*graphviz version ([^ ]+) .*" "\\\\1" GRAPHVIZ_VERSION "\$\{GRAPHVIZ_VERSION\}")
  message(STATUS "Found Graphviz: \$\{GRAPHVIZ_EXECUTABLE\} (found version \\"\$\{GRAPHVIZ_VERSION\}\\")")
  add_custom_target(
    graphviz
    COMMAND \$\{CMAKE_COMMAND\} "--graphviz=\$\{PROJECT_BINARY_DIR\}/\$\{CMAKE_GRAPHVIZ_OUTPUT_DIR\}/graph.dot" .
    COMMAND \$\{GRAPHVIZ_EXECUTABLE\} -T\$\{CMAKE_GRAPHVIZ_OUTPUT_TYPE\} "\$\{PROJECT_BINARY_DIR\}/\$\{CMAKE_GRAPHVIZ_OUTPUT_DIR\}/graph.dot" -o "\$\{PROJECT_BINARY_DIR\}/\$\{CMAKE_GRAPHVIZ_OUTPUT_DIR\}/graph.\$\{CMAKE_GRAPHVIZ_OUTPUT_TYPE\}"
    WORKING_DIRECTORY "\$\{CMAKE_BINARY_DIR\}"
  )
else()
  add_custom_target(
    graphviz
    COMMAND \$\{CMAKE_COMMAND\} "--graphviz=\$\{PROJECT_BINARY_DIR\}/\$\{CMAKE_GRAPHVIZ_OUTPUT_DIR\}/graph.dot" .
    WORKING_DIRECTORY "\$\{CMAKE_BINARY_DIR}"
  )
endif()
